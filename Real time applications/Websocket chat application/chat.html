<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="users"></div>
    <div class="chat-container"></div>
    <div>

        <input type="hidden" id="person-id">
    </div>
    <div>
        <input type="text" id="messageInput" placeholder="Type your message">
        <button id="sendButton">Send</button>
    </div>
    <div id="messageLog"></div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');




        const socket = new WebSocket('ws://localhost:8080');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messageLog = document.getElementById('messageLog');
        const userSentId = document.getElementById('person-id');

        // Event listener for when the connection is established
        socket.addEventListener('open', (event) => {
            console.log('WebSocket connection is open');

            socket.send(userId);

            sendButton.addEventListener('click', () => {
                const messageContent = messageInput.value;
                const personId = userSentId.value;

                // Create a JSON object
                const dataToSend = {
                    message: messageContent,
                    personId: personId,
                    senderId: userId
                };

                // Convert the JSON object to a JSON string and send it
                socket.send(JSON.stringify(dataToSend));

                // Clear input fields
                messageInput.value = '';
                // userSentId.value = '';
            });
        });

        // Event listener for when a message is received from the server
        socket.addEventListener('message', (event) => {
            const receivedMessage = event.data;
            console.log('Message from server:', receivedMessage);

            // Display the received message in the message log
            const messageElement = document.createElement('p');
            messageElement.textContent = receivedMessage;
            messageLog.appendChild(messageElement);
        });

        // Event listener for when the connection is closed
        socket.addEventListener('close', (event) => {
            console.log('WebSocket connection is closed');
        });

        // Event listener for errors
        socket.addEventListener('error', (event) => {
            console.error('WebSocket error:', event);
        });


        // Function to fetch user data and create buttons
        function createSidebarButtons() {
            const usersDiv = $('.users');

            // Make an AJAX GET request to fetch user IDs
            $.ajax({
                url: 'http://localhost:3000/users', // Replace with your API endpoint
                method: 'GET',
                success: function (userData) {
                    // Loop through the user data and create buttons
                    userData.forEach(user => {
                        const button = $('<button>')
                            .text(user.name)
                            .attr('data-userid', user.id)
                            .on('click', function () {
                                const userId = $(this).data('userid');
                                $('#person-id').val(userId);
                                fetchChatMessages(userId);
                                // Open the chat window or trigger sending a message
                                // You can implement your chat UI logic here
                            });
                        usersDiv.append(button);
                    });
                },
                error: function (error) {
                    console.error('Error fetching user data:', error);
                }
            });
        }

        function fetchChatMessages(userId) {
            $.ajax({
                url: `http://localhost:3000/messages/${userId}`,
                method: 'GET',
                success: function (messages) {
                    $('#messageLog').empty();
                    console.log(messages);
                    messages.forEach(messageObject => {
                        const messageContent = messageObject.Message;
                        displayMessage(messageContent);
                    });
                },
                error: function (error) {
                    console.error('Error fetching chat messages:', error);
                }
            });
        }

        function displayMessage(messageContent) {
            const messageLog = document.getElementById('messageLog');
            const messageElement = document.createElement('p');
            messageElement.textContent = messageContent;
            messageLog.appendChild(messageElement);
        }



        $(document).ready(function () {
            createSidebarButtons();
        });
    </script>
</body>

</html>