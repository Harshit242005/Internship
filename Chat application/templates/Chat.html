<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/Chat.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>

<body>

    <div class="container">
        <div class="left-container">
            <div class="User-Search"><input type="text" placeholder="Search people"></div>
            <div class="Users">
                <!-- here will all the users come -->
                {% for user in Others %}
                <button class="user-button" id="{{ user[0] }}">{{ user[1] }}</button>
                {% endfor %}
            </div>
        </div>
        <div class="right-container">
            <div class="text-container">

            </div>
            <div class="text-creater">
                <form id="message-form" method="post" action="/Chat" enctype="multipart/form-data">

                    <input type="hidden" name="selectedUserId" value="">
                    <input type="text" placeholder="Type your message..." name="message" />
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function () {
        $(".Users button").click(function () {
            var Selected;
            $(".Users button").css({ "background-color": "", "color": "black" }); // Reset background color for all buttons
            $(this).css({ "background-color": "black", "color": "white" }); // Set background color for the clicked button
            
            var selectedUserId = $(this).attr("id");
            Selected = selectedUserId;
            $("#message-form input[name='selectedUserId']").val(selectedUserId);
            var message = $("#message-form input[name='message']").val();


            $.ajax({
                type: "GET",
                url: "/Chat",
                data: { selectedUserId: selectedUserId },
                success: function (response) {
                    var messageData = JSON.parse(response); // Parse the JSON response
                    var textContainer = $(".text-container");
                    textContainer.empty(); // Clear existing messages
                    messageData.forEach(function (messageObj) {
                        var message = messageObj.message; // Extract message content
                        var timestamp = messageObj.timestamp; // Extract timestamp
                        var senderId = messageObj.sender_id; // Extract sender ID
                        var receiverId = messageObj.receiver_id; // Extract receiver ID
                        var messageId = messageObj.message_id;
                        var loginId = messageObj.user_id;
                        var isMine = senderId === loginId;

                        var messageDiv = $("<div>").addClass(isMine ? "mine" : "chat").html(`
                            <p>Message: ${message}</p>
                            <p>${timestamp}</p>
                            <button class="delete-button ${isMine ? 'show' : 'hide'}" data-message-id="${messageId}">Delete</button>
                        `);

                        textContainer.append(messageDiv); // Use prepend to add new messages at the bottom
                    });

                },
                error: function (xhr, status, error) {
                    console.error(error); // Handle errors if needed
                }
            });
        });


        $(document).on("click", ".delete-button", function () {
            var messageId = $(this).data("message-id");

            // Send AJAX request to delete the message
            $.ajax({
                type: "POST",
                url: "/delete-message", // Replace with your backend endpoint
                data: { message_id: messageId },
                success: function (response) {
                    // Handle success, e.g., remove the deleted message from the UI
                    $(`.chat[data-message-id="${messageId}"]`).remove();

                    reloadChatMessages(Selected);

                },
                error: function (error) {
                    // Handle error
                    console.error("Error deleting message:", error);
                }
            });

        });

        function reloadChatMessages(selectedUserId) {
            // Send GET request to fetch updated chat messages
            $.ajax({
                type: "GET",
                url: "/Chat",
                data: { selectedUserId: selectedUserId },
                success: function (response) {
                    var messageData = JSON.parse(response);
                    var textContainer = $(".text-container");
                    textContainer.empty(); // Clear existing messages
                    messageData.forEach(function (messageObj) {
                        // ... Your message rendering logic here ...
                        var message = messageObj.message; // Extract message content
                        var timestamp = messageObj.timestamp; // Extract timestamp
                        var senderId = messageObj.sender_id; // Extract sender ID
                        var receiverId = messageObj.receiver_id; // Extract receiver ID
                        var messageId = messageObj.message_id;
                        var loginId = messageObj.user_id;
                        var isMine = senderId === loginId;

                        var messageDiv = $("<div>").addClass(isMine ? "mine" : "chat").html(`
                            <p>Message: ${message}</p>
                            <p>${timestamp}</p>
                            <button class="delete-button" data-message-id="${messageId}">Delete</button>
                        `);
                        alert("you are called");
                        textContainer.append(messageDiv); // Use prepend to add new messages at the bottom
                    });
                },
                error: function (xhr, status, error) {
                    console.error(error); // Handle errors if needed
                }
            });



        }
    });
</script>


</html>